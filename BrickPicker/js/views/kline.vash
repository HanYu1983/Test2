<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        var origin = @html.raw(model.data)
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(start);
      
      function start(){
          drawKline()
          drawKd()
      }

  function drawKline() {
    var data = google.visualization.arrayToDataTable(origin, true);

    var options = {
      legend:'none'
    };

    var chart = new google.visualization.CandlestickChart(document.getElementById('chart_div'));

    chart.draw(data, options);
  }
  
  function drawKd() {
    
    
    var rsvLine = []
    
    for(var i=9; i<origin.length; ++i){
        [openTime, low, open, close, high] = origin[i]
        var before9k = origin.slice(i-9, i)
        var min9k = Math.min.apply(null, before9k.map(([_, low])=>low))
        var max9k = Math.max.apply(null, before9k.map(([_, _2, _3, _4, h])=>h))
        var rsv = (close - min9k)*100/(max9k - min9k)
        rsvLine.push(rsv)
    }
    
    var kline = []
    var dline = []
    for(var i=0; i<rsvLine.length; ++i){
        var rsv = rsvLine[i]
        var prevK = 0
        var prevD = 0
        if(i>0){
            prevK = kline[i-1]
            prevD = dline[i-1]
        }
        var k = prevK * (2/3) + rsv/3
        var d = prevD * (2/3) + k/3
        kline.push(k)
        dline.push(d)
    }
    
    var data = []
    for(var i=0; i<origin.length; ++i){
        [openTime] = origin[i]
        if(i<9){
            data.push([openTime, 0, 0])
            continue
        }
        data.push([openTime, kline[i-9], dline[i-9]])
    }
    
    data = [['time', 'k', 'd']].concat(data)
    data = google.visualization.arrayToDataTable(data)
    
    var options = {
      title: 'Company Performance',
      curveType: 'function',
      legend: { position: 'bottom' }
    };

    var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

    chart.draw(data, options);
  }
  
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <div id="curve_chart" style="width: 900px; height: 500px"></div>
  </body>
</html>