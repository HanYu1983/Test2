<!DOCTYPE html>
<html lang="zh-hans">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
  <div id="app">
    
  <div class="navBar">
    <div class="inner">
      <div class="left">
        <div class="logo"><img src="../assets/img/symbols-diamond-logo.png"></div>
        <h1 class="textshadow">You Are My Diamond 买钻石</h1>
      </div>
      <div class="links">
        <a href="./index.html">介紹</a>
        <a href="../index.html">首頁</a>
      </div>
    </div>
  </div>
  <div class="contentPage">
    <h3 class="textshadow">最后一个下订钻石的将获得</h3>
    <div class="point">
      <img src="../assets/img/symbols.png" />
      <img src="../assets/img/symbols-arrow.png" alt="">
      <div class="num">未實作</div>
      <img src="../assets/img/symbols-ethereum-logo.png">
    </div>
    <div class="time textshadow">
      <h4>下订倒数</h4>
      <div>{{ temp.remainTimeFormat }}</div>
    </div>
    <a v-on:click="buy(1)">
      1x
      <img src="../assets/img/symbols-ring.png"> 买个钻石讨老婆
    </a>
    <img src="../assets/img/symbols-diamond-.png" class="center">
    <div class="tabSide">
      <div class="leftTab">
        <ul class="tab" data-tabgroup="first-tab-group">
          <li class="active"><a href="#tab1">购 买</a></li>
          <li><a href="#tab2">玩家资讯</a></li>
          <li><a href="#tab3">合伙人</a></li>
        </ul>

        <div class="tabContent" id = "first-tab-group">
          <div class="tabBox" id="tab1">
            <h4>立即购买钻石 </h4>
            <span>立即购买钻石，加入钻石竞标会！</span>
            <div class="f-right"><label for="">当前钻价:</label><span>{{temp.keyPriceEth}}</span><span>ＥＴＨ</span></div>
            <div class="greenBox">
              <img src="../assets/img/symbols.png" alt="">
              <div><input type="text" v-model="temp.keyAmount">颗钻石</div>
              <div>约为<span>{{temp.keyPriceEth}}</span>ETH</div>
            </div>
            <table class="greenTable">
              <tr>
                <td><button v-on:click="addKeyAmount(1)">+<span>1</span>钻石</button></td>
                <td><button v-on:click="addKeyAmount(2)">+<span>2</span>钻石</button></td>
                <td><button v-on:click="addKeyAmount(5)">+<span>5</span></button></td>
                <td><button v-on:click="addKeyAmount(10)">+<span>10</span></button></td>
                <td><button v-on:click="addKeyAmount(100)">+<span>100</span></button></td>
              </tr>
            </table>
            <button v-on:click="buy(temp.keyAmount)">确认购买</button>
          </div>

          <div class="tabBox" id="tab2">
            <ul class="playerInfo">
              <li>
                <label>領先分紅</label>
                <span>{{ playerInfo.win }}</span>
              </li>
              <li>
                <label>通常錢包</label>
                <span>{{ playerInfo.gen }}</span>
              </li>
              <li>
                <label>推薦分紅</label>
                <span>{{ playerInfo.fri }}</span>
              </li>
              <li>
                <label>合夥分紅</label>
                <span>{{ playerInfo.par }}</span>
              </li>
            </ul>
            <button class="right">复制</button>
          </div>

          <div class="tabBox" id="tab3">
            <h3>说明</h3>
            <h4>开盘前</h4>
            <ul class="payInfo">
              <li><span>付费<b>0.5</b>ETH 成为合伙人</span><i><img src="../assets/img/whiteArrow.png"></i><span>抽成整个团队业绩的<b>2%</b></span></li>
              <li><span>付费<b>1</b>ETH 成为合伙人</span><i><img src="../assets/img/whiteArrow.png"></i><span>抽成整个团队业绩的<b>4%</b></span></li>
            </ul>
            <h4>开盘后1个月</h4>
            <ul class="payInfo">
              <li><span>付费<b>0.5</b>ETH 成为合伙人</span><i><img src="../assets/img/whiteArrow.png"></i><span>抽成整个团队业绩的<b>2%</b></span></li>
              <li><span>付费<b>1</b>ETH 成为合伙人</span><i><img src="../assets/img/whiteArrow.png"></i><span>抽成整个团队业绩的<b>4%</b></span></li>
            </ul>
            <div class="btnSide">
              <button>注册成为普通合伙人</button>
              <button>注册成为高级合伙人</button>
            </div>
          </div>
          
        </div>
      </div>
      <div class="rightTab">
        <ul class="tab" data-tabgroup="second-tab-group">
          <li class="active"><a href="#tab4">摘 要</a></li>
          <li><a href="#tab5">统 计</a></li>
        </ul>
        <div class="tabContent" id="second-tab-group">
          <div class="tabBox" id="tab4">
            <ul class="summaryBox">
              <li>
                <label for="">当前回合数：</label>
                <span>{{ roundInfo.rnd }}</span>
              </li>
              <li>
                <label for="">游戏剩余时间：</label>
                <span>{{ temp.remainTimeFormat }}</span>
              </li>
              <li>
                <label for="">彩池：</label>
                <span>{{ roundInfo.pot }}</span>
              </li>
              <li>
                <label for="">游戏状态：{{ roundInfo.state }}</label>
                <ul>
                  <li><i>1.</i><span>游戏进行中，时间持续倒数</span></li>
                  <li><i>2.</i><span>前一局已结束，新局开始，等待玩家开局，时间不到数</span></li>
                </ul>
              </li>
            </ul>
          </div>

          <div class="tabBox" id="tab5">
            <ul class="stat">
              <li><label>投资总额</label><span class="textshadow">2854.6483</span><i><img src="../assets/img/symbols-ethereum-logo.png"></i></li>
              <li><label>已分发奖金</label><span class="textshadow">2854.6483</span><i><img src="../assets/img/symbols-ethereum-logo.png"></i></li>
              <li><label>已延长时间</label><span class="textshadow">5.31</span><i class="textshadow">年</i></li>
            </ul>
            <div class="timeBox">
              <span>167,514,570</span>
              <i>秒</i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>
  
  <footer>
    2018 You Are My Diamond All Right Reserved
  </footer>
  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
  <script src="../assets/js/main.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="../js/truffle-contract.js"></script>
  <script src="../js/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.2/rxjs.umd.min.js"></script>
  
  <script>
      // https://ropsten.etherscan.io/tx/0xfb3fd9245ff3461b19301fbfb7016b78f2cfa6e193bb7b2ecbe11c7cc4fd0acd
      
      var oneEther = 1000000000000000000;
      
      var model = model || {};
      (function(module){
          var fixPointFactor = 1000000000;
          //var ContractAddress = "0xd9e7e1a4f723f5d45f02067c385ba4287755305d"  // kovan testnet
          var ContractAddress = "0xf71b622b854222fabaeaab68c4d18c0ff88ee46e"
          var contract = 0
          // tx: https://etherscan.io/tx/0xc62495bb98256669d6ac760c9352c23ce21a94d6ff2e62d2b29f4d90a337bc86
          //var distributeAddress = "0xd240eb94e0d4e77c3c0f8c7343d4601673accc4e"
          
          async function loadContract(){
              return $.getJSON('../contracts/YAMDMain.json', function(data) {
                  var Clz = TruffleContract(data);
                  Clz.setProvider(web3.currentProvider);
              
                  contract = Clz.at(ContractAddress)
                  console.log(contract)
              });
          }
          
          function getContract(){
              return contract
          }
          
          async function loadRoundInfo(){
              var info = await contract.getRoundInfo()
              var [rnd, startTime, endTime, remainTime, com, pot, pub, state, lastPlyrId] = info
              return {
                  "rnd": rnd.toNumber(),
                  "startTime": startTime,
                  "endTime": endTime, 
                  "remainTime": remainTime.toNumber(),
                  "com": com.dividedBy(model.fixPointFactor).toNumber(),
                  "pot": pot.dividedBy(model.fixPointFactor).toNumber(),
                  "pub": pub.dividedBy(model.fixPointFactor).toNumber(),
                  "state": state.toNumber(),
                  "lastPlyrId": lastPlyrId.toNumber()
              }
          }
          
          async function loadPlayerInfo(){
              var info = await contract.getPlayerInfo()
              var [key, win, gen, fri, par, friendLink] = info
              return {
                  "key": key.dividedBy(model.fixPointFactor).toNumber(),
                  "win": win.dividedBy(model.fixPointFactor).toNumber(),
                  "gen": gen.dividedBy(model.fixPointFactor).toNumber(),
                  "fri": fri.dividedBy(model.fixPointFactor).toNumber(),
                  "par": par.dividedBy(model.fixPointFactor).toNumber(),
                  "friendLink": friendLink
              }
          }
          
          module.loadContract = loadContract
          module.getContract = getContract
          module.loadRoundInfo = loadRoundInfo
          module.fixPointFactor = fixPointFactor
          module.loadPlayerInfo = loadPlayerInfo
      })(model)
      
      function main(){
          var vueModel = new Vue({
            el: '#app',
            data: {
                temp:{
                    keyAmount: 1.01,
                    keyPriceWei:0,
                    keyPriceEth:0.0,
                    remainTimeFormat:"",
                    partnerLink:"",
                    usedPartnerLink: "",
                    usedFriendLink: "",
                    usePartner: false,
                    useFriend: false
                },
                roundInfo: {
                  "rnd": 0,
                  "startTime": 0,
                  "endTime": 0, 
                  "remainTime": 0,
                  "com": 0,
                  "pot": 0,
                  "pub": 0,
                  "state": 0,
                  "lastPlyrId": 0
                },
                playerInfo: {
                    key: 0,
                    win: 0,
                    gen: 0,
                    fri: 0,
                    par: 0,
                    friendLink: "link"
                }
            },
            methods:{
                buy: (keyAmount)=>{
                    (async function(){
                        var contract = model.getContract()
                        console.log('user...')
                        try{
                            if(vueModel.temp.usePartner){
                                var link = vueModel.temp.usedPartnerLink
                                await contract.buyWithPartnerLink(link, {value: vueModel.temp.keyPriceWei, gas: 2100000})
                            }else if(vueModel.temp.useFriend){
                                var link = vueModel.temp.usedFriendLink
                                await contract.buyWithFriendLink(link, {value: vueModel.temp.keyPriceWei, gas: 2100000})
                            }else{
                                await contract.buy({value: vueModel.temp.keyPriceWei, gas: 2100000})
                            }
                            console.log('user end')
                            await loadData()
                        }catch(e){
                            console.log(e)
                        }
                        
                        
                        //0xa6f2ae3a buy
                        //0x749aa2d9 nextRound
                        
                        /*
                        web3.eth.estimateGas({
                            to: "", 
                            data: "0xa6f2ae3a"
                        }, (ret)=>{
                            console.log(ret)
                        });
                        */
                        
                    })()
                },
                vaultBuy: (keyAmount)=>{
                    (async function(){
                        var contract = model.getContract()
                        console.log('user...')
                        try{
                            
                            if(vueModel.temp.usePartner){
                                var link = vueModel.temp.usedPartnerLink
                                await contract.vaultBuyWithPartnerLink(vueModel.temp.keyPriceWei, link, {value: vueModel.temp.keyPriceWei, gas: 2100000})
                            }else if(vueModel.temp.useFriend){
                                var link = vueModel.temp.usedFriendLink
                                await contract.vaultBuyWithFriendLink(vueModel.temp.keyPriceWei, link, {value: vueModel.temp.keyPriceWei, gas: 2100000})
                            }else{
                                await contract.vaultBuy(vueModel.temp.keyPriceWei, {gas: 2100000})
                            }
                            console.log('user end')
                            await loadData()
                        }catch(e){
                            console.log(e)
                        }
                    })()
                },
                getKeyPrice: (keyAmount)=>{
                    (async function(){
                        var contract = model.getContract()
                        var price = await contract.getKeyPrice(keyAmount * model.fixPointFactor)
                        //console.log(vueModel)
                        vueModel.temp.keyPriceWei = price.toNumber()
                        vueModel.temp.keyPriceEth = vueModel.temp.keyPriceWei / oneEther
                    })()
                },
                withdraw: ()=>{
                    (async function(){
                        var contract = model.getContract()
                        try{
                            await contract.withdraw()
                            await loadData()
                        }catch(e){
                            console.log(e)
                        }
                    })()
                },
                addKeyAmount:(keyAmount)=>{
                    vueModel.temp.keyAmount += parseFloat(keyAmount)
                },
                getPartnerLink: ()=>{
                    (async function(){
                        var contract = model.getContract()
                        try{
                            var link = await contract.getPartnerLink()
                            await loadData()
                            vueModel.temp.partnerLink = link
                        }catch(e){
                            console.log(e)
                        }
                    })()
                },
                registerPartner: (level)=>{
                    (async function(){
                        var contract = model.getContract()
                        try{
                            var fee = await contract.getPartnerProjectFee(level)
                            await contract.registerPartner(level, {value: fee})
                        }catch(e){
                            console.log(e)
                        }
                    })()
                }
            }
          })
          
          var loadData = async ()=>{
              var contract = model.getContract()
              var roundInfo = await model.loadRoundInfo()
              console.log(roundInfo)
              
              var playerInfo = await model.loadPlayerInfo()
              console.log(playerInfo)
              
              vueModel.roundInfo = roundInfo
              vueModel.playerInfo = playerInfo
          }
          
          
          var start = async ()=>{
              await model.loadContract()
              await loadData()
              
              var update = ()=>{
                  var remainSecond = --vueModel.roundInfo.remainTime
                  if(remainSecond < 0){
                      remainSecond = 0
                  }
                  var date = new Date(remainSecond*1000)
                  vueModel.temp.remainTimeFormat = date.getUTCHours()+":"+date.getUTCMinutes()+":"+date.getUTCSeconds()
              }
              setInterval(update, 1000)
          }
          
          start()
      }
      //window.onload = main
      $(main)
  </script>
</body>

</html>